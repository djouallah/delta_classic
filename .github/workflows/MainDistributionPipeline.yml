#
# Full build: all platforms. Manual trigger or tag push.
# GitHub Pages deployment only happens on tag pushes (v*).
#
name: Main Extension Distribution Pipeline
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' && github.sha || '' }}
  cancel-in-progress: true

jobs:
  duckdb-stable-build:
    name: Build extension binaries
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.5.0
    with:
      duckdb_version: v1.5-variegata
      ci_tools_version: v1.5.0
      extension_name: delta_classic

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: duckdb-stable-build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create directory structure
        run: |
          for platform in linux_amd64 linux_arm64 linux_amd64_musl osx_amd64 osx_arm64 windows_amd64 windows_amd64_mingw; do
            mkdir -p deploy/v1.5-variegata/${platform}
          done

      - name: Download linux_amd64
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: delta_classic-v1.5-variegata-extension-linux_amd64
          path: artifacts/linux_amd64/

      - name: Download linux_arm64
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: delta_classic-v1.5-variegata-extension-linux_arm64
          path: artifacts/linux_arm64/

      - name: Download linux_amd64_musl
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: delta_classic-v1.5-variegata-extension-linux_amd64_musl
          path: artifacts/linux_amd64_musl/

      - name: Download osx_amd64
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: delta_classic-v1.5-variegata-extension-osx_amd64
          path: artifacts/osx_amd64/

      - name: Download osx_arm64
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: delta_classic-v1.5-variegata-extension-osx_arm64
          path: artifacts/osx_arm64/

      - name: Download windows_amd64
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: delta_classic-v1.5-variegata-extension-windows_amd64
          path: artifacts/windows_amd64/

      - name: Download windows_amd64_mingw
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: delta_classic-v1.5-variegata-extension-windows_amd64_mingw
          path: artifacts/windows_amd64_mingw/

      - name: Gzip and arrange artifacts
        run: |
          for platform in linux_amd64 linux_arm64 linux_amd64_musl osx_amd64 osx_arm64 windows_amd64 windows_amd64_mingw; do
            if [ -f "artifacts/${platform}/delta_classic.duckdb_extension" ]; then
              gzip -c "artifacts/${platform}/delta_classic.duckdb_extension" > "deploy/v1.5-variegata/${platform}/delta_classic.duckdb_extension.gz"
              echo "Packaged ${platform}"
            else
              echo "Skipping ${platform} (not found)"
            fi
          done

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
